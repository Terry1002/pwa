<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RC èµ›é“è¥è¿ç³»ç»Ÿ</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* CSS æ ·å¼ä¸ä¸Šä¸€ç‰ˆå®Œå…¨ä¸€è‡´ï¼Œä¿æŒèµ›è½¦é£æ ¼ä¸å˜ */
        :root { --primary: #e53935; --primary-dark: #b71c1c; --bg: #f4f4f8; --card-bg: #ffffff; --text: #2c3e50; --accent: #ff9800; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, 'Helvetica Neue', sans-serif; }
        body { background-color: var(--bg); color: var(--text); padding-bottom: 75px; }
        .header-container { position: sticky; top: 0; z-index: 100; }
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; text-align: center; padding: 16px; font-size: 19px; font-weight: 800; letter-spacing: 1px; font-style: italic; }
        .checkered-bar { height: 6px; background: repeating-linear-gradient(45deg, #111 0, #111 10px, #fff 10px, #fff 20px); }
        #loginView { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, #2c3e50, #000000); padding: 20px; position: fixed; top: 0; left: 0; width: 100%; z-index: 999; }
        .login-card { background: white; width: 100%; max-width: 350px; padding: 30px 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center; border-top: 5px solid var(--primary); }
        .login-logo { font-size: 40px; margin-bottom: 10px; }
        .login-title { font-size: 22px; font-weight: 900; font-style: italic; color: #111; margin-bottom: 20px; }
        .container { padding: 15px; display: none; animation: fadeIn 0.3s ease; }
        .active-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--card-bg); border-radius: 12px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); border-top: 3px solid transparent; }
        .card-red-top { border-top-color: var(--primary); }
        h3 { font-size: 17px; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; color: #1a252f; }
        input { width: 100%; padding: 14px 14px; margin: 8px 0; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: border-color 0.2s; background: #fafafa; text-align: center; }
        input:focus { outline: none; border-color: var(--primary); background: #fff; }
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; color: white; cursor: pointer; margin-top: 10px; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, #e53935, #c62828); box-shadow: 0 4px 10px rgba(229, 57, 53, 0.3); }
        .btn-play { background: linear-gradient(135deg, #34a853, #2e7d32); box-shadow: 0 4px 10px rgba(52, 168, 83, 0.3); }
        .btn-outline { background: white; color: var(--text); border: 2px solid #ddd; }
        .customer-info { margin-top: 15px; background: #f8f9fa; border-radius: 8px; padding: 15px; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 15px; color: #555; }
        .count-highlight { color: var(--accent); font-size: 24px; font-weight: 900; font-style: italic; }
        .record-list { margin-top: 20px; }
        .record-list h4 { font-size: 15px; color: #7f8c8d; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .record-item { display: flex; justify-content: space-between; align-items: center; font-size: 14px; padding: 10px 0; border-bottom: 1px dashed #ecf0f1; }
        .record-time { color: #95a5a6; font-size: 13px; font-family: monospace; }
        .record-recharge { color: #2e7d32; font-weight: bold; background: #e8f5e9; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .record-usage { color: #c62828; font-weight: bold; background: #ffebee; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .customer-list-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .cl-name { font-size: 16px; font-weight: bold; color: #2c3e50; }
        .cl-phone { font-size: 13px; color: #7f8c8d; margin-top: 4px; font-family: monospace; }
        .cl-count { font-size: 20px; font-weight: 900; color: var(--accent); text-align: right; font-style: italic; }
        .cl-action { font-size: 12px; color: var(--primary); margin-top: 4px; font-weight: bold; }
        .tab-bar { position: fixed; bottom: 0; width: 100%; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); display: none; border-top: 1px solid #e0e0e0; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -2px 10px rgba(0,0,0,0.03); }
        .tab-item { flex: 1; text-align: center; padding: 12px 0; font-size: 12px; color: #95a5a6; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .tab-icon { font-size: 20px; }
        .tab-item.active { color: var(--primary); font-weight: bold; }
        .tab-item.active .tab-icon { transform: scale(1.1); }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .stat-box { background: var(--card-bg); padding: 18px 10px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.04); }
        .stat-val { font-size: 26px; font-weight: 900; color: var(--primary); margin-top: 8px; font-style: italic; }
        #appContent { display: none; }
    </style>
</head>
<body>

    <div id="loginView">
        <div class="login-card">
            <div class="login-logo">ğŸï¸</div>
            <div class="login-title">RC èµ›é“è¥è¿ç³»ç»Ÿ</div>
            <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 20px;">è¯·è¾“å…¥æŠ€å¸ˆæˆæƒç å…¥åœº</p>
            <input type="password" id="authCode" placeholder="æˆæƒç  (æ¼”ç¤ºå¡«: 8888)" inputmode="numeric">
            <button class="btn-primary" onclick="handleLogin()" style="margin-top: 20px;">ğŸ”‘ è®¤è¯å¹¶å¯åŠ¨</button>
        </div>
    </div>

    <div id="appContent">
        <div class="header-container">
            <div class="header" id="headerTitle">ğŸ PitåŒº / æ§åˆ¶å°</div>
            <div class="checkered-bar"></div>
        </div>

        <div id="workspaceView" class="container active-view">
            <div class="card card-red-top">
                <h3>ğŸ” å‘¼å«è½¦æ‰‹æ¡£æ¡ˆ</h3>
                <input type="tel" id="phoneInput" placeholder="è¾“å…¥è½¦æ‰‹æ‰‹æœºå· (11ä½)" maxlength="11">
                <button class="btn-primary" onclick="handleSearch()">æ£€ç´¢èµ„æ–™</button>
            </div>
            <div id="customerPanel" class="card" style="display: none;">
                <h3>ğŸï¸ è½¦æ‰‹çŠ¶æ€</h3>
                <div class="customer-info">
                    <div class="info-row"><span>è½¦æ‰‹ä»£å·ï¼š</span><strong id="cName">-</strong></div>
                    <div class="info-row"><span>è”ç»œç»ˆç«¯ï¼š</span><span id="cPhone" style="font-family: monospace;">-</span></div>
                    <div class="info-row" style="margin-top: 10px; border-top: 1px dashed #ddd; padding-top: 10px;">
                        <span>å‰©ä½™å¯ç”¨èŠ‚æ•°ï¼š</span><span id="cCount" class="count-highlight">0</span>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button class="btn-play" onclick="deductCount()" id="btnDeduct">ğŸ ä¸‹åœºå‘è½¦ (æ‰£æ¬¡)</button>
                    <button class="btn-outline" onclick="toggleRecharge()">â›½ è´­ä¹°ç¥¨å·</button>
                </div>
                <div id="rechargePanel" style="display: none; background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #ffe0b2;">
                    <h4 style="color: #e65100; margin-bottom: 10px;">è¿›ç«™è¡¥ç»™ (å……å€¼)</h4>
                    <input type="number" id="rechargeAmount" placeholder="æ”¯ä»˜é‡‘é¢ (å…ƒ)">
                    <input type="number" id="rechargeCount" placeholder="å¢åŠ èŠ‚æ•°/æ¬¡æ•°">
                    <button class="btn-primary" onclick="submitRecharge()" id="btnRecharge" style="background: linear-gradient(135deg, #f57c00, #e65100);">ç¡®è®¤å…¥è´¦</button>
                </div>
                <div class="record-list" id="recordList"></div>
            </div>
        </div>

        <div id="customersView" class="container">
             <div class="card card-red-top">
                <h3>ğŸ“ æ–°ç§€è½¦æ‰‹æ³¨å†Œ</h3>
                <input type="tel" id="regPhone" placeholder="è¾“å…¥æ‰‹æœºå· (å¿…å¡«)" maxlength="11">
                <input type="text" id="regName" placeholder="è¾“å…¥è½¦æ‰‹å§“åæˆ–èŠ±å">
                <button class="btn-primary" onclick="registerCustomer()" id="btnRegister">å»ºæ¡£å…¥åº“</button>
            </div>
            <div class="card">
                <h3>ğŸ† å›´åœºè½¦æ‰‹åå•</h3>
                <div id="allCustomersList">æ­£åœ¨åŠ è½½èµ›é“æ•°æ®...</div>
            </div>
        </div>

        <div id="statsView" class="container">
             <div class="card card-red-top">
                <h3>ğŸ“… èµ›é“è¥è¿å‘¨æœŸç­›é€‰</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="date" id="startDate">
                    <span style="color: #7f8c8d; font-weight: bold;">è‡³</span>
                    <input type="date" id="endDate">
                </div>
                <button class="btn-outline" onclick="loadStats()">åˆ†ææ•°æ®</button>
            </div>
            <div class="stat-grid">
                <div class="stat-box" style="grid-column: span 2; background: linear-gradient(135deg, #1e3c72, #2a5298); color: white;">
                    <div style="color: #bbdefb;">æ€»è¥æ”¶æµæ°´ (å…ƒ)</div>
                    <div class="stat-val" id="statAmount" style="color: #fff; font-size: 32px;">0.00</div>
                </div>
                <div class="stat-box">
                    <div style="color: #7f8c8d; font-size: 13px;">å……å€¼å•æ•°</div>
                    <div class="stat-val" id="statRechargeCount" style="color: #2c3e50;">0</div>
                </div>
                <div class="stat-box">
                    <div style="color: #7f8c8d; font-size: 13px;">ä¸‹åœºæ€»äººæ¬¡</div>
                    <div class="stat-val" id="statUsageCount" style="color: var(--accent);">0</div>
                </div>
            </div>
        </div>

        <div class="tab-bar" id="bottomTabBar">
            <div class="tab-item active" onclick="switchTab('workspace')">
                <span class="tab-icon">âš™ï¸</span><span>PitåŒº</span>
            </div>
            <div class="tab-item" onclick="switchTab('customers')">
                <span class="tab-icon">ğŸï¸</span><span>è½¦æ‰‹åº“</span>
            </div>
            <div class="tab-item" onclick="switchTab('stats')">
                <span class="tab-icon">ğŸ“Š</span><span>é¥æµ‹æ•°æ®</span>
            </div>
        </div>
    </div>

<script>
    // ğŸš¦ æ ¸å¿ƒé…ç½®ï¼šæ¥å…¥ä½ çš„çœŸå®äº‘ç«¯å¤§è„‘
    const API_BASE = 'https://rcapi.terryterry.website';
    let currentPhone = null;

    // --- ç™»å½•é€»è¾‘ ---
    function handleLogin() {
        const code = document.getElementById('authCode').value;
        if (code === '8888') {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';
            document.getElementById('bottomTabBar').style.display = 'flex';
            sessionStorage.setItem('isLoggedIn', 'true'); 
        } else {
            alert('âŒ æˆæƒç é”™è¯¯ï¼Œæ‹’ç»è®¿é—®ï¼');
        }
    }
    if (sessionStorage.getItem('isLoggedIn') === 'true') {
        document.getElementById('loginView').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        document.getElementById('bottomTabBar').style.display = 'flex';
    }

    // --- è¾…åŠ©å‡½æ•°ï¼šç½‘ç»œè¯·æ±‚å°è£… ---
    async function apiGet(path) {
        const response = await fetch(API_BASE + path);
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
        return data;
    }

    async function apiPost(path, bodyData) {
        const response = await fetch(API_BASE + path, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bodyData)
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
        return data;
    }

    function formatTime(timestamp) {
        const d = new Date(timestamp);
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
    }

    // --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (å·²æ¥å…¥ API) ---

    // 1. æŸ¥è¯¢è½¦æ‰‹
    async function handleSearch() {
        const phone = document.getElementById('phoneInput').value.trim();
        if (phone.length !== 11) return alert('è¯·è¾“å…¥å®Œæ•´çš„11ä½æ‰‹æœºå·');

        try {
            const data = await apiGet(`/api/customer?phone=${phone}`);
            currentPhone = phone;
            showCustomerPanel(data.customer, data.recharges, data.usages);
        } catch (err) {
            alert('æ•°æ®åº“ä¸­æœªæ‰¾åˆ°è¯¥è½¦æ‰‹ï¼è¯·å‰å¾€â€œè½¦æ‰‹åº“â€ä¸ºæ‚¨åŠç†æ³¨å†Œã€‚');
            document.getElementById('customerPanel').style.display = 'none';
        }
    }

    // 2. æ³¨å†Œæ–°è½¦æ‰‹
    async function registerCustomer() {
        const phone = document.getElementById('regPhone').value.trim();
        const name = document.getElementById('regName').value.trim() || 'ç¥ç§˜è½¦æ‰‹';
        if (phone.length !== 11) return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„11ä½æ‰‹æœºå·');
        
        const btn = document.getElementById('btnRegister');
        btn.innerText = 'æ³¨å†Œä¸­...'; btn.disabled = true;

        try {
            await apiPost('/api/customer', { phone, name });
            alert('æ–°ç§€è½¦æ‰‹å»ºæ¡£æˆåŠŸï¼');
            document.getElementById('regPhone').value = '';
            document.getElementById('regName').value = '';
            renderAllCustomers(); // åˆ·æ–°åˆ—è¡¨
        } catch (err) {
            alert('æ³¨å†Œå¤±è´¥: ' + err.message);
        } finally {
            btn.innerText = 'å»ºæ¡£å…¥åº“'; btn.disabled = false;
        }
    }

    // 3. æ¸²æŸ“æ‰€æœ‰è½¦æ‰‹åˆ—è¡¨
    async function renderAllCustomers() {
        const listDiv = document.getElementById('allCustomersList');
        listDiv.innerHTML = '<div style="text-align:center; color:#bdc3c7; padding:30px 0;">ğŸ“¡ æ­£åœ¨ä»äº‘ç«¯è¯»å–æ•°æ®...</div>';
        
        try {
            const customerArray = await apiGet('/api/customers');
            if (customerArray.length === 0) {
                listDiv.innerHTML = '<div style="text-align:center; color:#bdc3c7; padding:30px 0;">å½“å‰èµ›é“ç©ºæ— ä¸€äºº</div>';
                return;
            }
            let html = '';
            customerArray.forEach(c => {
                html += `<div class="customer-list-item" onclick="jumpToWorkspace('${c.phone}')"><div><div class="cl-name">${c.name}</div><div class="cl-phone">${c.phone}</div></div><div><div class="cl-count">${c.count} <span style="font-size:12px;font-style:normal;color:#7f8c8d;">æ¬¡</span></div><div class="cl-action">è¿›å…¥Pitæˆ¿ &gt;</div></div></div>`;
            });
            listDiv.innerHTML = html;
        } catch (err) {
            listDiv.innerHTML = `<div style="text-align:center; color:#e53935; padding:30px 0;">è·å–æ•°æ®å¤±è´¥: ${err.message}</div>`;
        }
    }

    function jumpToWorkspace(phone) {
        switchTab('workspace');
        document.getElementById('phoneInput').value = phone;
        // è‡ªåŠ¨è§¦å‘æŸ¥è¯¢
        handleSearch();
    }

    // 4. å±•ç¤ºé¡¾å®¢é¢æ¿å’Œæ˜ç»†
    function showCustomerPanel(customer, recharges, usages) {
        document.getElementById('customerPanel').style.display = 'block';
        document.getElementById('rechargePanel').style.display = 'none';
        document.getElementById('cName').innerText = customer.name;
        document.getElementById('cPhone').innerText = customer.phone;
        document.getElementById('cCount').innerText = customer.count;
        
        const recordList = document.getElementById('recordList');
        const _recharges = recharges.map(r => ({ ...r, type: 'recharge' }));
        const _usages = usages.map(u => ({ ...u, type: 'usage' }));
        const combinedRecords = [..._recharges, ..._usages].sort((a, b) => b.time - a.time);

        if (combinedRecords.length === 0) {
            recordList.innerHTML = '<div style="text-align:center; color:#bdc3c7; font-size:13px; margin-top:20px;">æš‚æ— èµ›é“é¥æµ‹è®°å½•</div>';
            return;
        }

        let html = '<h4>â±ï¸ è¿›ç«™åŠä¸‹åœºé¥æµ‹æ—¥å¿—</h4>';
        combinedRecords.forEach(record => {
            const timeStr = formatTime(record.time);
            if (record.type === 'recharge') {
                html += `<div class="record-item"><div><span class="record-recharge">è¡¥ç»™ç¥¨å·</span><br><span class="record-time">${timeStr}</span></div><div style="text-align:right;">+${record.add_count} æ¬¡<br><span style="color:#7f8c8d;font-size:12px;">(Â¥${record.amount})</span></div></div>`;
            } else {
                html += `<div class="record-item"><div><span class="record-usage">èµ›é“å‘è½¦</span><br><span class="record-time">${timeStr}</span></div><div style="font-weight:bold;color:#c62828;">-1 æ¬¡</div></div>`;
            }
        });
        recordList.innerHTML = html;
    }

    function toggleRecharge() {
        const panel = document.getElementById('rechargePanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    // 5. å……å€¼æäº¤
    async function submitRecharge() {
        const amount = parseFloat(document.getElementById('rechargeAmount').value);
        const count = parseInt(document.getElementById('rechargeCount').value);
        if (!amount || !count) return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ²¹èµ„(é‡‘é¢)å’ŒèŠ‚æ•°(æ¬¡æ•°)');
        
        const btn = document.getElementById('btnRecharge');
        btn.innerText = 'å¤„ç†ä¸­...'; btn.disabled = true;

        try {
            await apiPost('/api/recharge', { phone: currentPhone, amount, count });
            alert('â›½ è¡¥ç»™å…¥è´¦æˆåŠŸï¼');
            document.getElementById('rechargeAmount').value = '';
            document.getElementById('rechargeCount').value = '';
            // å……å€¼æˆåŠŸåï¼Œé‡æ–°è·å–è¯¥è½¦æ‰‹çš„æœ€æ–°æ•°æ®åˆ·æ–°é¢æ¿
            await handleSearch();
        } catch (err) {
            alert('å……å€¼å¤±è´¥: ' + err.message);
        } finally {
            btn.innerText = 'ç¡®è®¤å…¥è´¦'; btn.disabled = false;
        }
    }

    // 6. æ‰£æ¬¡å‘è½¦
    async function deductCount() {
        if(confirm('ç»¿ç¯äº®èµ·ï¼ç¡®è®¤å‘è½¦å¹¶æ‰£é™¤ 1 æ¬¡æ¸¸ç©èŠ‚æ•°å—ï¼Ÿ')) {
            const btn = document.getElementById('btnDeduct');
            btn.innerText = 'è¯·ç¨å...'; btn.disabled = true;
            try {
                await apiPost('/api/usage', { phone: currentPhone });
                // æ‰£å‡æˆåŠŸåï¼Œé‡æ–°è·å–æ•°æ®åˆ·æ–°é¢æ¿
                await handleSearch();
            } catch (err) {
                alert('å‘è½¦å¤±è´¥: ' + err.message);
            } finally {
                btn.innerText = 'ğŸ ä¸‹åœºå‘è½¦ (æ‰£æ¬¡)'; btn.disabled = false;
            }
        }
    }

    // 7. ç»Ÿè®¡æŠ¥è¡¨
    function initStatsDates() {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
        document.getElementById('endDate').value = now.toISOString().split('T')[0];
    }

    async function loadStats() {
        const start = new Date(document.getElementById('startDate').value).getTime();
        const end = new Date(document.getElementById('endDate').value).setHours(23, 59, 59, 999);
        
        try {
            const stats = await apiGet(`/api/stats?start=${start}&end=${end}`);
            document.getElementById('statAmount').innerText = (stats.totalAmount || 0).toFixed(2);
            document.getElementById('statRechargeCount').innerText = stats.totalRechargeCount || 0;
            document.getElementById('statUsageCount').innerText = stats.totalUsageCount || 0;
        } catch (err) {
            alert('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + err.message);
        }
    }

    // --- Tab é¡µé¢åˆ‡æ¢ ---
    function switchTab(tab) {
        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.container').forEach(el => el.classList.remove('active-view'));
        if (tab === 'workspace') {
            document.querySelector('.tab-item:nth-child(1)').classList.add('active');
            document.getElementById('workspaceView').classList.add('active-view');
            document.getElementById('headerTitle').innerText = 'ğŸ PitåŒº / æ§åˆ¶å°';
        } else if (tab === 'customers') {
            document.querySelector('.tab-item:nth-child(2)').classList.add('active');
            document.getElementById('customersView').classList.add('active-view');
            document.getElementById('headerTitle').innerText = 'ğŸ† å›´åœºè½¦æ‰‹åº“';
            renderAllCustomers();
        } else if (tab === 'stats') {
            document.querySelector('.tab-item:nth-child(3)').classList.add('active');
            document.getElementById('statsView').classList.add('active-view');
            document.getElementById('headerTitle').innerText = 'ğŸ“Š èµ›é“é¥æµ‹æ•°æ®';
            if(!document.getElementById('startDate').value) initStatsDates();
            loadStats();
        }
    }
</script>
</body>
</html>